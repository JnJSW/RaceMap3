<!--
@license
Copyright (c) 2015 John Schweikert. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="route-panel">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <paper-card class="layout vertical">

      <paper-icon-item>
        <iron-icon icon="maps:my-location" style="width=24px;height=24px;" item-icon></iron-icon>
        <span class="flex">My Location</span>
      </paper-icon-item>
    
      <!--<iron-list id="waypointList" items="[[_waypointPlaces]]" selection-enabled ><template>-->
      <template is="dom-repeat" items="[[_waypointPlaces]]">
        <paper-icon-item>
          <iron-image src="[[item.markerUrl]]" style="width=24px;height=24px;" item-icon></iron-image>
          <span class="flex"><span>[[item.name]]</span>,&nbsp;<span>[[item.state]]</span></span>
          <span><span>[[_getDistance(index)]]</span>&nbsp;m</span>
        </paper-icon-item>
      </template>
      <!--</template></iron-list>-->

      <paper-icon-item>
        <iron-icon icon="maps:local-bar" style="width=24px;height=24px;" item-icon></iron-icon>
        <span class="flex">[[appOptions.finalDestination]]</span>
        <!--<span class="flex"><paper-input value="[[appOptions.finalDestination]]"></paper-input></span>-->
      </paper-icon-item>

      <paper-checkbox checked={{appOptions.avoidHighways}}>Avoid Highways</paper-checkbox>
      <paper-checkbox checked={{appOptions.optimizeWaypoints}}>Optimize Waypoints</paper-checkbox>

      <google-map-directions start-address="[[myLocation]]"
                            end-address="[[appOptions.finalDestination]]"
                            map="{{map}}"
                            travel-mode="DRIVING"
                            waypoints="[[_waypointLatLngs]]"
                            optimize-waypoints="[[appOptions.optimizeWaypoints]]"
                            avoid-highways="[[appOptions.avoidHighways]]"
                            on-google-map-response="_handleDirectionsResponse"></google-map-directions>

    </paper-card>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'route-panel',

      properties: {
        myLocation: {
          type: Object
        },
        appOptions: {
          type: Object
        },
        map: {
          type: Object
        },
        _waypointPlaces: {
          type: Array,
          value: []
        },
        _waypointLatLngs: {
          type: Array,
          computed: '_getWaypointLatLngs(_waypointPlaces, _waypointPlaces.*)'
        },
        _waypointOrder: {
          type: Array
        }
      },

      addWaypoint: function(place) {
        this.push('_waypointPlaces', place);
      },
      
      _getWaypointLatLngs: function() {
        var latLngs = [];
        this._waypointPlaces.forEach(function(place){
          latLngs.push( {
            location: new google.maps.LatLng(place.lat, place.lng),
            stopover: true
          });
        });
        return latLngs;
      },

      _getDistance: function(index) {
        if (typeof google === 'undefined') {
          return;
        }
        else {
          var from = (index === 0) ? this.myLocation : this._waypointPlaces[index-1];
          var to = this._waypointPlaces[index];
          return Math.round(google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(from.lat, from.lng), new google.maps.LatLng(to.lat, to.lng)) * 0.000621371);
        }
      },
      
      _handleDirectionsResponse: function(e) {
        console.log("handleDirections Response " + e);
        console.log(e);
      }
      
      
    });
  })();
  </script>
</dom-module>
