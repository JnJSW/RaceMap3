<!--
@license
Copyright (c) 2015 John Schweikert. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="my-location">
  <template>
    <google-maps-api on-api-load="_mapApiLoaded" libraries="places,geometry"></google-maps-api>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'my-location',

      properties: {

        myLocation: {
          type: Object,
          readOnly: true,
          notify: true
        },
        
        myRoute: {
          type: Array,
          readOnly: true,
          notify: true,
          value: []
        },
        
        milesTraveled: {
          type: Number,
          computed: '_formatMilesTraveled(_miles)',
          readOnly: true,
          notify: true
        },
        
        _miles: {
          type: Number,
          value: 0
        }
        
      },
  
      _updatePosition: function(position) {
        var priorLatLng = this.myLocation;
        this._setMyLocation ({
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy,

          altitude: position.coords.altitude,
          altitudeAccuracy: position.coords.altitudeAccuracy,

          heading: position.coords.heading,
          speed: position.coords.speed,
        });

        if (typeof priorLatLng != 'undefined') {
          var milesFromPrior = google.maps.geometry.spherical.computeDistanceBetween(priorLatLng, this.myLocation) * 0.000621371;
          this._miles = this._miles + milesFromPrior;
        }
        
        this.push('myRoute', this.myLocation);
        console.log('myLocation ' + JSON.stringify(this.myLocation));
      },
      
      _mapApiLoaded: function() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(this._updatePosition.bind(this), function() {}, {enableHighAccuracy: true});
        } else {
            console.log( 'Geolocation is not supported by this browser');
        }
      },
      
      _formatMilesTraveled: function (_miles) {
        return _miles.toFixed(1);
      }


    });
  })();
  </script>
</dom-module>
